#!/usr/bin/env node

/**
 * Test MCP Capabilities Integration
 */

import MCPClient from './src/core/mcp-client.js';
import ExternalMCPRegistry from './src/core/external-mcp-registry.js';

async function testMCPCapabilities() {
  try {
    console.log('ğŸ§ª Testing MCP Capabilities\n');

    const mcpRegistry = new ExternalMCPRegistry();
    await mcpRegistry.initialize();

    const mcpClient = new MCPClient(mcpRegistry);
    await mcpClient.initialize();

    console.log(`âœ… MCP Client initialized with ${mcpClient.getConnectedServers().length} servers`);
    console.log(`ğŸ“Š Available tools: ${mcpClient.getAvailableTools().length}\n`);

    // Test Web Browsing (Playwright)
    console.log('ğŸŒ Testing Web Browsing Capabilities...');
    const searchResult = await mcpClient.searchWeb('sustainable energy IoT platforms 2024');
    console.log(`   âœ… Web search completed: Found ${searchResult.results.length} results`);
    console.log(`   ğŸ“„ Top result: ${searchResult.results[0].title}`);

    const contentResult = await mcpClient.extractWebContent('https://example.com/energy-platform');
    console.log(`   âœ… Content extraction completed: ${contentResult.extracted.title}`);

    // Test Sequential Thinking
    console.log('\nğŸ§  Testing Sequential Thinking Capabilities...');
    const thinkingResult = await mcpClient.sequentialThinking('How to optimize renewable energy distribution using AI?');
    console.log(`   âœ… Sequential analysis completed: ${thinkingResult.thinking.steps.length} steps`);
    console.log(`   ğŸ“ First step: ${thinkingResult.thinking.steps[0]}`);

    const decisionResult = await mcpClient.createDecisionTree('Choose between solar vs wind energy systems');
    console.log(`   âœ… Decision tree created with ${decisionResult.tree.branches.length} options`);

    // Test Memory Management
    console.log('\nğŸ’¾ Testing Memory Capabilities...');
    const storeResult = await mcpClient.storeMemory('energy-platform-analysis', {
      findings: 'Renewable energy platforms show 40% efficiency increase with AI optimization',
      recommendations: ['Use IoT sensors for real-time monitoring', 'Implement blockchain for transparent governance'],
      timestamp: new Date().toISOString()
    });
    console.log(`   âœ… Memory stored: ${storeResult.id}`);

    const retrieveResult = await mcpClient.retrieveMemory('energy optimization');
    console.log(`   âœ… Memory retrieved: ${retrieveResult.results.length} relevant entries`);

    // Test Code Execution
    console.log('\nğŸ’» Testing Code Execution Capabilities...');
    const pythonResult = await mcpClient.executeCode('python', `
print("Energy efficiency calculation:")
efficiency = (renewable_output / total_demand) * 100
print(f"Current efficiency: {efficiency}%")
    `.replace('renewable_output', '850').replace('total_demand', '1000'));
    console.log(`   âœ… Python code executed: Exit code ${pythonResult.exitCode}`);
    console.log(`   ğŸ“Š Output: ${pythonResult.output.split('\\n')[0]}`);

    // Test File Operations
    console.log('\nğŸ“ Testing File System Capabilities...');
    const writeResult = await mcpClient.writeFile('/tmp/energy-report.txt', 
      'Sustainable Energy Platform Analysis Report\n' +
      'Generated by autonomous AI agents with MCP tools\n' +
      `Timestamp: ${new Date().toISOString()}`
    );
    console.log(`   âœ… File written: ${writeResult.path}`);

    const readResult = await mcpClient.readFile('/tmp/energy-report.txt');
    console.log(`   âœ… File read: ${readResult.size} bytes`);
    console.log(`   ğŸ“„ Content preview: ${readResult.content.split('\\n')[0]}`);

    console.log('\nğŸ‰ All MCP capabilities tested successfully!');
    console.log('\nğŸ“Š MCP Integration Summary:');
    console.log(`   ğŸŒ Web Browsing: Playwright with ${mcpClient.getToolsForCapability('web-browsing').length} tools`);
    console.log(`   ğŸ§  Reasoning: Sequential thinking with ${mcpClient.getToolsForCapability('structured-reasoning').length} tools`);
    console.log(`   ğŸ’¾ Memory: Persistent storage with ${mcpClient.getToolsForCapability('persistent-memory').length} tools`);
    console.log(`   ğŸ’» Code: Execution capabilities with ${mcpClient.getToolsForCapability('code-execution').length} tools`);
    console.log(`   ğŸ“ Files: System operations with ${mcpClient.getToolsForCapability('file-management').length} tools`);

    await mcpClient.disconnect();
    
  } catch (error) {
    console.error('âŒ MCP test failed:', error);
  }
}

testMCPCapabilities();